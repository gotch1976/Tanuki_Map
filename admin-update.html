<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†è€…ï¼šéƒ½é“åºœçœŒä¸€æ‹¬æ›´æ–° | Tanuki Map</title>
  <link rel="stylesheet" href="css/main.css?v=10">
  <style>
    .admin-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
      padding-top: calc(70px + 2rem);
    }
    .admin-card {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    .admin-card h2 {
      margin-top: 0;
      color: #8B4513;
    }
    .progress-info {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
      font-family: monospace;
      max-height: 300px;
      overflow-y: auto;
    }
    .progress-line {
      margin: 0.25rem 0;
    }
    .progress-line.success { color: green; }
    .progress-line.error { color: red; }
    .progress-line.skip { color: orange; }
    .stats {
      display: flex;
      gap: 2rem;
      margin: 1rem 0;
    }
    .stat-item {
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #8B4513;
    }
    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <button id="backBtn" class="btn-secondary">â† æˆ»ã‚‹</button>
      <h1>ğŸ”§ ç®¡ç†è€…ãƒ„ãƒ¼ãƒ«</h1>
      <div id="userInfo" style="display: none;">
        <img id="userPhoto" alt="User" class="user-photo">
        <span id="userName"></span>
      </div>
    </div>
  </header>

  <div class="admin-container">
    <div class="admin-card">
      <h2>éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬æ›´æ–°</h2>
      <p>æ—¢å­˜ã®ãŸã¬ããƒ‡ãƒ¼ã‚¿ã«éƒ½é“åºœçœŒæƒ…å ±ã‚’è¿½åŠ ã—ã¾ã™ã€‚<br>
      ç·¯åº¦çµŒåº¦ã‹ã‚‰é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¦éƒ½é“åºœçœŒã‚’å–å¾—ã—ã€Firestoreã‚’æ›´æ–°ã—ã¾ã™ã€‚</p>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="totalCount">-</div>
          <div class="stat-label">ç·ä»¶æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="needUpdateCount">-</div>
          <div class="stat-label">æ›´æ–°å¯¾è±¡</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completedCount">0</div>
          <div class="stat-label">å®Œäº†</div>
        </div>
      </div>

      <button id="checkBtn" class="btn-secondary">çŠ¶æ³ã‚’ç¢ºèª</button>
      <button id="updateBtn" class="btn-primary" disabled>ä¸€æ‹¬æ›´æ–°ã‚’å®Ÿè¡Œ</button>

      <div id="progressInfo" class="progress-info" style="display: none;"></div>
    </div>
  </div>

  <div id="loading" class="loading">å‡¦ç†ä¸­...</div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- ã‚¢ãƒ—ãƒªã®JavaScript -->
  <script src="js/config.js?v=10"></script>
  <script src="js/utils.js?v=10"></script>
  <script src="js/firebase-init.js?v=10"></script>
  <script src="js/auth.js?v=10"></script>

  <script>
    let allTanukis = [];
    let tanukisToUpdate = [];

    // åˆæœŸåŒ–ï¼ˆGoogle Maps APIã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    window.initAdmin = function() {
      console.log('initAdmin é–‹å§‹');

      if (!initFirebase()) {
        showError('Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }
      setupFirestore();
      console.log('FirestoreåˆæœŸåŒ–å®Œäº†, db:', db);

      initAuth();

      document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = 'index.html';
      });

      const checkBtn = document.getElementById('checkBtn');
      const updateBtn = document.getElementById('updateBtn');

      console.log('checkBtn:', checkBtn);
      console.log('updateBtn:', updateBtn);

      checkBtn.addEventListener('click', () => {
        console.log('checkBtn ã‚¯ãƒªãƒƒã‚¯');
        checkStatus();
      });

      updateBtn.addEventListener('click', () => {
        console.log('updateBtn ã‚¯ãƒªãƒƒã‚¯');
        runBulkUpdate();
      });

      console.log('initAdmin å®Œäº†');
    };

    // çŠ¶æ³ç¢ºèª
    async function checkStatus() {
      console.log('checkStatus é–‹å§‹');

      // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
      if (!currentUser) {
        showError('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
        return;
      }
      console.log('currentUser:', currentUser.email);

      showLoading('ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªä¸­...');

      try {
        console.log('Firestoreã‚¯ã‚¨ãƒªé–‹å§‹');
        const snapshot = await db.collection('tanukis')
          .where('status', '==', 'active')
          .get();
        console.log('Firestoreã‚¯ã‚¨ãƒªå®Œäº†, ä»¶æ•°:', snapshot.size);

        allTanukis = [];
        tanukisToUpdate = [];

        snapshot.forEach(doc => {
          const data = doc.data();
          data.id = doc.id;
          allTanukis.push(data);

          // prefectureãŒãªã„ã€ã¾ãŸã¯ã€Œä¸æ˜ã€ã®ã‚‚ã®ã‚’æ›´æ–°å¯¾è±¡ã«
          if ((!data.prefecture || data.prefecture === 'ä¸æ˜') && data.location) {
            tanukisToUpdate.push(data);
          }
        });

        console.log('allTanukis:', allTanukis.length);
        console.log('tanukisToUpdate:', tanukisToUpdate.length);

        document.getElementById('totalCount').textContent = allTanukis.length;
        document.getElementById('needUpdateCount').textContent = tanukisToUpdate.length;

        if (tanukisToUpdate.length > 0) {
          document.getElementById('updateBtn').disabled = false;
          addProgressLine(`${tanukisToUpdate.length}ä»¶ã®æ›´æ–°å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`, 'info');
        } else {
          addProgressLine('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã«éƒ½é“åºœçœŒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™', 'success');
        }

        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
        showError('ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ä¸€æ‹¬æ›´æ–°å®Ÿè¡Œ
    async function runBulkUpdate() {
      if (tanukisToUpdate.length === 0) {
        showError('æ›´æ–°å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      document.getElementById('updateBtn').disabled = true;
      document.getElementById('checkBtn').disabled = true;
      showLoading('æ›´æ–°ä¸­...');

      let completed = 0;
      let errors = 0;

      for (const tanuki of tanukisToUpdate) {
        try {
          const { latitude, longitude } = tanuki.location;
          const prefecture = await getPrefecture(latitude, longitude);

          if (prefecture) {
            await db.collection('tanukis').doc(tanuki.id).update({
              prefecture: prefecture
            });
            completed++;
            addProgressLine(`âœ“ ${tanuki.id}: ${prefecture}`, 'success');
          } else {
            addProgressLine(`âš  ${tanuki.id}: éƒ½é“åºœçœŒã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ`, 'skip');
          }
        } catch (error) {
          errors++;
          addProgressLine(`âœ— ${tanuki.id}: ${error.message}`, 'error');
        }

        document.getElementById('completedCount').textContent = completed;

        // APIåˆ¶é™å¯¾ç­–: å°‘ã—å¾…æ©Ÿ
        await new Promise(resolve => setTimeout(resolve, 200));
      }

      hideLoading();
      addProgressLine(`\nå®Œäº†: ${completed}ä»¶æˆåŠŸ, ${errors}ä»¶ã‚¨ãƒ©ãƒ¼`, 'info');
      showSuccess(`æ›´æ–°å®Œäº†: ${completed}ä»¶`);

      document.getElementById('checkBtn').disabled = false;
    }

    // éƒ½é“åºœçœŒã‚’å–å¾—
    async function getPrefecture(lat, lng) {
      const geocoder = new google.maps.Geocoder();

      return new Promise((resolve) => {
        console.log('Geocoding:', lat, lng);
        geocoder.geocode({ location: { lat, lng } }, (results, status) => {
          console.log('Geocodeçµæœ:', status, results);

          if (status === 'OK' && results[0]) {
            const addressComponents = results[0].address_components;
            console.log('address_components:', addressComponents);

            const prefectureComponent = addressComponents.find(c =>
              c.types.includes('administrative_area_level_1')
            );

            if (prefectureComponent) {
              console.log('éƒ½é“åºœçœŒç™ºè¦‹:', prefectureComponent.long_name);
              resolve(prefectureComponent.long_name);
              return;
            }

            // æµ·å¤–ã®å ´åˆã¯å›½å
            const countryComponent = addressComponents.find(c =>
              c.types.includes('country')
            );
            if (countryComponent && countryComponent.long_name !== 'æ—¥æœ¬') {
              console.log('æµ·å¤–:', countryComponent.long_name);
              resolve(countryComponent.long_name);
              return;
            }
          }
          console.log('éƒ½é“åºœçœŒä¸æ˜');
          resolve('ä¸æ˜');
        });
      });
    }

    // é€²æ—è¡¨ç¤ºã«è¿½åŠ 
    function addProgressLine(text, type) {
      const container = document.getElementById('progressInfo');
      container.style.display = 'block';

      const line = document.createElement('div');
      line.className = `progress-line ${type}`;
      line.textContent = text;
      container.appendChild(line);
      container.scrollTop = container.scrollHeight;
    }
  </script>

  <!-- Google Maps API (initAdminå®šç¾©å¾Œã«èª­ã¿è¾¼ã‚€) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_djMpDkNHMKX7CPsK81m8TSVB42gC6gw&callback=initAdmin"></script>
</body>
</html>
